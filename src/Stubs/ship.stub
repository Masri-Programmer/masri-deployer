#!/bin/bash
# ship.sh - Deployment with Auto-Rollback, Forced Execution & Status Checks
set -e

# --- CONFIGURATION ---
REMOTE_USER="{{REMOTE_USER}}"
REMOTE_HOST="{{REMOTE_HOST}}"
REMOTE_APP_PATH="{{REMOTE_APP_PATH}}"
REMOTE_DEPLOY_SCRIPT="${REMOTE_APP_PATH}/deploy.sh"
SSR_PROCESS="{{SSR_PROCESS}}"
TRANSLATION_KEY="{{TRANSLATION_KEY}}"
PM2_PATH="{{PM2_PATH}}" 
if [ "$PM2_PATH" == "{{PM2_PATH}}" ]; then PM2_PATH="pm2"; fi

# Detect if we are on Windows (Git Bash) or Linux/Mac for PHP
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
    # Adjust this to your specific Herd path if not in global PATH
    LOCAL_PHP_BIN="C:\Users\Admin\.config\herd\bin\php.bat"
else
    LOCAL_PHP_BIN="php"
fi

# --- MODE: STATUS CHECK ---
# Run this if the user types: ./ship.sh status
if [ "$1" == "status" ]; then
    echo "üîç Checking Remote Server Status..."
    echo "---------------------------------------------------"
    
    ssh "${REMOTE_USER}@${REMOTE_HOST}" "
        echo 'üìä PM2 Process Status:'
        $PM2_PATH list | grep '$SSR_PROCESS' || echo '‚ùå SSR Process NOT FOUND'
        echo ''
        echo 'üõ†Ô∏è  Laravel Maintenance Mode:'
        if [ -f ${REMOTE_APP_PATH}/storage/framework/down ]; then
            echo '‚ùå Application is DOWN (Maintenance Mode active)'
        else
            echo '‚úÖ Application is LIVE'
        fi
        
        echo ''
        echo 'üíæ Disk Usage (Build Folder):'
        du -sh ${REMOTE_APP_PATH}/public/build 2>/dev/null || echo '‚ö†Ô∏è Build folder missing'
    "
    echo "---------------------------------------------------"
    exit 0
fi

# --- CLEANUP & ROLLBACK MECHANISM ---
cleanup() {
    local exit_code=$?
    echo ""
    if [ $exit_code -ne 0 ]; then
        echo "‚ùå DEPLOYMENT FAILED! (Exit Code: $exit_code)"
        echo "‚ö†Ô∏è  Restoring old assets..."
        ssh "${REMOTE_USER}@${REMOTE_HOST}" "
            # Restore Public Build
            if [ -d '${REMOTE_APP_PATH}/public/build_backup' ]; then
                rm -rf '${REMOTE_APP_PATH}/public/build'
                mv '${REMOTE_APP_PATH}/public/build_backup' '${REMOTE_APP_PATH}/public/build'
            fi
            # Restore SSR Build
            if [ -d '${REMOTE_APP_PATH}/bootstrap/ssr_backup' ]; then
                rm -rf '${REMOTE_APP_PATH}/bootstrap/ssr'
                mv '${REMOTE_APP_PATH}/bootstrap/ssr_backup' '${REMOTE_APP_PATH}/bootstrap/ssr'
            fi
            echo '‚úÖ Assets restored.'
            echo 'üîÑ Emergency: Bringing site back online (Old Version)...'
            cd ${REMOTE_APP_PATH} && php artisan up
        "
    else
        echo "üîÑ Reloading SSR Process & Cleaning up..."
        ssh "${REMOTE_USER}@${REMOTE_HOST}" "
             rm -rf ${REMOTE_APP_PATH}/public/build_backup
             rm -rf ${REMOTE_APP_PATH}/bootstrap/ssr_backup
             # Reload PM2
             $PM2_PATH reload $SSR_PROCESS
        "
        echo "‚úÖ DEPLOYMENT FINISHED SUCCESSFULLY!"
    fi
}
trap cleanup EXIT

echo "--- Starting Deployment Package ---"

# --- STEP 1: PRE-FLIGHT ---
echo "üîÑ Ensuring Git is in sync..."
git pull --rebase origin main

# --- STEP 2: VERSIONING ---
echo "üì¶ Select version bump? [patch (default) / minor / major / none]"
read BUMP
if [ -z "$BUMP" ]; then BUMP="patch"; fi

if [ "$BUMP" != "none" ]; then
    echo "üîñ Bumping version ($BUMP)..."
    # Bump version but don't commit yet
    npm version $BUMP --no-git-tag-version
    
    NEW_VERSION=$(node -p "require('./package.json').version")
    echo "‚úÖ New Version is: $NEW_VERSION"

    echo "üì∏ Committing Version Bump..."
    git add package.json package-lock.json
    git commit -m "chore: shipment release $NEW_VERSION"
fi

# --- STEP 3: LOCAL BUILD ---
echo "üåç Syncing Translations Locally..."
if [ -z "$TRANSLATION_KEY" ] || [ "$TRANSLATION_KEY" == "{{TRANSLATION_KEY}}" ]; then
    "$LOCAL_PHP_BIN" artisan translate:local --all || echo "‚ö†Ô∏è Translation command skipped (not found)"
else
    "$LOCAL_PHP_BIN" artisan translate:local --all --key="$TRANSLATION_KEY"
fi

echo "üõ†Ô∏è  Building Assets (SSR Mode)..."
export NODE_OPTIONS="--max-old-space-size=4096"
npm run build:ssr

# --- STEP 4: PREPARE SERVER ---
echo "üõ°Ô∏è  Backing up remote assets & Maintenance Mode..."
ssh "${REMOTE_USER}@${REMOTE_HOST}" "
    # Remove old backups if they exist
    rm -rf ${REMOTE_APP_PATH}/public/build_backup
    rm -rf ${REMOTE_APP_PATH}/bootstrap/ssr_backup

    # Backup Public Build
    if [ -d '${REMOTE_APP_PATH}/public/build' ]; then
        cp -r ${REMOTE_APP_PATH}/public/build ${REMOTE_APP_PATH}/public/build_backup
    fi
    # Backup SSR Build
    if [ -d '${REMOTE_APP_PATH}/bootstrap/ssr' ]; then
        cp -r ${REMOTE_APP_PATH}/bootstrap/ssr ${REMOTE_APP_PATH}/bootstrap/ssr_backup
    fi
    
    # Create SSR directory if missing
    mkdir -p ${REMOTE_APP_PATH}/bootstrap/ssr
    
    # Enter Maintenance Mode
    cd ${REMOTE_APP_PATH} && php artisan down || true
"

# --- STEP 5: UPLOAD ASSETS (RSYNC/SCP) ---
echo "üì§ Uploading public/build to Server..."
# Clean destination first to ensure no stale files
ssh "${REMOTE_USER}@${REMOTE_HOST}" "rm -rf ${REMOTE_APP_PATH}/public/build/*"
scp -r -C -p public/build/* "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_APP_PATH}/public/build/"

echo "üì§ Uploading bootstrap/ssr to Server..."
# Clean destination
ssh "${REMOTE_USER}@${REMOTE_HOST}" "rm -rf ${REMOTE_APP_PATH}/bootstrap/ssr/*"
scp -r -C -p bootstrap/ssr/* "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_APP_PATH}/bootstrap/ssr/"

# --- STEP 6: PUSH BACKEND ---
echo "üíæ Pushing Laravel Backend Code..."
git push origin main

# --- STEP 7: EXECUTE REMOTE DEPLOY ---
echo "‚ö° Executing Remote Deployment Script..."
ssh "${REMOTE_USER}@${REMOTE_HOST}" "bash ${REMOTE_DEPLOY_SCRIPT}"